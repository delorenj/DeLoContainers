services:
  node-red:
    build: .
    container_name: node-red
    restart: unless-stopped
    user: "${PUID:-1000}:${PGID:-1000}"
    environment:
      - TZ=${TZ:-America/Los_Angeles}
      - NODE_RED_ENABLE_PROJECTS=${NODE_RED_ENABLE_PROJECTS:-false}
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL}
      - BLOODBANK_HTTP_URL=${BLOODBANK_HTTP_URL}
      - BLOODBANK_EXCHANGE=${BLOODBANK_EXCHANGE:-bloodbank.events.v1}
      - BLOODBANK_RABBIT_URL=${BLOODBANK_RABBIT_URL}
      - FIREFLIES_API_KEY=${FIREFLIES_API_KEY}
      - FIREFLIES_WEBHOOK_URL=${FIREFLIES_WEBHOOK_URL}
      - WATCH_DIR=/watch
      - PUBLIC_DIR=/public
      - TRANSCRIPT_DIR=/transcriptions
    volumes:
      - ./data:/data
      - ${WATCH_DIR}:/watch:ro
      - ${PUBLIC_DIR}:/public:rw
      - ${TRANSCRIPT_DIR}:/transcriptions:rw
      - ./flows:/flows:ro
    networks:
      - proxy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nodered.entrypoints=websecure"
      - "traefik.http.routers.nodered.rule=Host(`${NODERED_DOMAIN}`)"
      - "traefik.http.routers.nodered.tls=true"
      - "traefik.http.routers.nodered.tls.certresolver=letsencrypt"
      - "traefik.http.services.nodered.loadbalancer.server.port=1880"
      - "traefik.docker.network=proxy"

networks:
  proxy:
    external: true
    name: proxy
