#!/usr/bin/env bash
#MISE description="Run comprehensive troubleshooting for media stack"

set -euo pipefail

echo "ğŸ”§ Media Stack Troubleshooting"
echo "==============================="

echo ""
echo "1. ğŸ“Š Service Status:"
docker compose ps

echo ""
echo "2. ğŸ” Environment Variables Check:"
if [ -f ".env" ]; then
    echo "âœ… .env file exists"
    if grep -q "VPN_SERVICE_PROVIDER" .env; then
        echo "âœ… VPN_SERVICE_PROVIDER is set"
    else
        echo "âŒ VPN_SERVICE_PROVIDER not found in .env"
    fi
    if grep -q "OPENVPN_USER" .env; then
        echo "âœ… OPENVPN_USER is set"
    else
        echo "âŒ OPENVPN_USER not found in .env"
    fi
else
    echo "âŒ .env file not found"
fi

echo ""
echo "3. ğŸ“ Configuration Directories:"
for dir in prowlarr qbittorrent gluetun; do
    if [ -d "$dir" ]; then
        echo "âœ… $dir/ directory exists"
    else
        echo "âŒ $dir/ directory missing"
    fi
done

echo ""
echo "4. ğŸŒ Network Connectivity:"
if docker compose ps gluetun | grep -q "Up"; then
    echo "âœ… Gluetun VPN container is running"
    echo "ğŸ” Checking VPN connection..."
    docker compose exec gluetun wget -qO- ifconfig.me || echo "âŒ VPN connectivity test failed"
else
    echo "âŒ Gluetun VPN container is not running"
fi

echo ""
echo "5. ğŸ”— Service URLs:"
echo "- Prowlarr: http://localhost:9696"
echo "- qBittorrent: http://localhost:8080 (admin/adminadmin)"

echo ""
echo "6. ğŸ“‹ Recent Error Logs:"
echo "Gluetun errors:"
docker compose logs gluetun | grep -i error | tail -5 || echo "No recent errors"
echo ""
echo "qBittorrent errors:"
docker compose logs qbittorrent | grep -i error | tail -5 || echo "No recent errors"

echo ""
echo "ğŸ’¡ Common Solutions:"
echo "- VPN issues: Check credentials in .env, try different server"
echo "- qBittorrent issues: Ensure Gluetun is running first"
echo "- Port conflicts: Check if ports 8080, 9696 are available"
echo "- Permission issues: Check volume mount permissions"
