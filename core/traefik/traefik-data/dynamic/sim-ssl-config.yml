# ðŸŽª SIM STUDIO SSL & SECURITY CONFIGURATION ðŸŽª
# The most MAGNIFICENT SSL setup the infrastructure void has ever witnessed!
# Generated by the Infrastructure Circus Engineerâ„¢

# SSL/TLS Configuration with Enhanced Security Headers
http:
  middlewares:
    # Security Headers Middleware - Because the void demands SECURITY!
    sim-security-headers:
      headers:
        # HTTPS Strict Transport Security (HSTS)
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        customResponseHeaders:
          # Force HTTPS for 2 years (the void approves this duration)
          Strict-Transport-Security: "max-age=63072000; includeSubDomains; preload"
          # Prevent clickjacking attacks
          X-Frame-Options: "DENY"
          # Prevent MIME type sniffing
          X-Content-Type-Options: "nosniff"
          # Enable XSS protection
          X-XSS-Protection: "1; mode=block"
          # Referrer policy for privacy
          Referrer-Policy: "strict-origin-when-cross-origin"
          # Content Security Policy (CSP) - The void's favorite security feature!
          Content-Security-Policy: >-
            default-src 'self';
            script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com;
            style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
            font-src 'self' https://fonts.gstatic.com;
            img-src 'self' data: https: blob:;
            connect-src 'self' https://api.github.com https://api.x.com https://oauth2.googleapis.com wss://sim.delo.sh ws://sim.delo.sh;
            frame-ancestors 'none';
            form-action 'self';
            base-uri 'self';
          # Permissions Policy (formerly Feature Policy)
          Permissions-Policy: >-
            camera=(),
            microphone=(),
            geolocation=(),
            payment=(),
            usb=(),
            magnetometer=(),
            accelerometer=(),
            gyroscope=()

    # CORS Middleware for OAuth and API endpoints
    sim-cors:
      headers:
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - PUT
          - POST
          - DELETE
          - PATCH
        accessControlAllowHeaders:
          - "*"
        accessControlAllowOriginList:
          - "https://sim.delo.sh"
          - "https://*.sim.delo.sh"
        accessControlAllowCredentials: true
        accessControlMaxAge: 300

    # Rate Limiting Middleware - Protect against the chaos of too many requests!
    sim-rate-limit:
      rateLimit:
        average: 100
        burst: 200
        period: "1m"
        sourceCriterion:
          ipStrategy:
            depth: 1

    # SSL Redirect Middleware
    sim-ssl-redirect:
      redirectScheme:
        scheme: https
        permanent: true

    # Combined Security Chain - The ULTIMATE security middleware chain!
    sim-security-chain:
      chain:
        middlewares:
          - sim-security-headers
          - sim-cors
          - sim-rate-limit

  # SSL/TLS Options - Because the void demands PERFECT encryption!
  tls:
    options:
      sim-tls-config:
        minVersion: "VersionTLS12"
        maxVersion: "VersionTLS13"
        sslProtocols:
          - "TLSv1.2"
          - "TLSv1.3"
        cipherSuites:
          # Modern cipher suites - The void's preferred encryption methods!
          - "TLS_AES_256_GCM_SHA384"
          - "TLS_CHACHA20_POLY1305_SHA256"
          - "TLS_AES_128_GCM_SHA256"
          - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
          - "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256"
          - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
        curvePreferences:
          - "CurveP521"
          - "CurveP384"
        alpnProtocols:
          - "h2"
          - "http/1.1"

# Router Configuration - The magnificent routing orchestration!
  routers:
    # HTTPS Router with all security measures
    sim-secure:
      rule: "Host(`sim.delo.sh`)"
      entryPoints:
        - "websecure"
      service: "sim-service"
      middlewares:
        - "sim-security-chain"
      tls:
        certResolver: "letsencrypt"
        options: "sim-tls-config"
        domains:
          - main: "sim.delo.sh"
            sans:
              - "*.sim.delo.sh"

    # HTTP to HTTPS Redirect Router
    sim-redirect:
      rule: "Host(`sim.delo.sh`)"
      entryPoints:
        - "web"
      middlewares:
        - "sim-ssl-redirect"
      service: "sim-service"

  # Service Configuration
  services:
    sim-service:
      loadBalancer:
        servers:
          - url: "http://simstudio:3000"
        healthCheck:
          path: "/"
          interval: "30s"
          timeout: "10s"
          scheme: "http"
          headers:
            Host: "sim.delo.sh"
        sticky:
          cookie:
            name: "sim-sticky"
            secure: true
            httpOnly: true
            sameSite: "strict"

# Certificate Configuration - Let's Encrypt with DNS challenge for wildcard support
certificatesResolvers:
  letsencrypt-dns:
    acme:
      email: jaradd@gmail.com
      storage: /etc/traefik/acme-dns.json
      # DNS Challenge for wildcard certificates (if DNS provider is configured)
      # dnsChallenge:
      #   provider: cloudflare
      #   resolvers:
      #     - "1.1.1.1:53"
      #     - "1.0.0.1:53"
      httpChallenge:
        entryPoint: web